<hr>

[Account Registration](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study?tab=readme-ov-file#account-registration)  
[Auth Token bypass Macro](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study?tab=readme-ov-file#auth-token-bypass-macro)
### Account Registration

> Business logic flaw in the account registration feature allow for gaining foothold as target user role access. [Content Discovery](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study?tab=readme-ov-file#content-discovery) find the path `/admin`, message state the Admin interface is only available if logged in as a **DontWannaCry** user.

[![Register length flaw](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/raw/main/images/register-length-flaw.png)](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/blob/main/images/register-length-flaw.png)

> Creating email with more that 200 character before the `@` symbol is then truncated to 255 characters. This _**identify**_ the vulnerability in the account registration page logic **flaw**. In the email below the `m` at the end of `@dontwannacry.com` is character 255 exactly.
> 
> Spanish: Porque basicamente la funcionalidad por debajo trunca los 200 caracteres a 255, ahi vemos que elimina por completo el dominio de correo “@exploit-0a0f00ad03547c1081591bd401950084.exploit-server.net” y solo queda el nombre_correo, lo que significa que si registramos con los 255 caracteres solo nombre de user + @dontwannacry.com por ende solo nos tomara en cuenta ello y el dominio de correo lo borrará por completo así que tendremos el correo tal cual como lo queremos teniendo claramente permiso de administrador. 
>

```
very-long-strings-so-very-long-string-so-very-long-string-so-very-long-string-so-very-long-string-so-very-long-string-so-very-long-string-so-very-long-string-so-very-long-string-so-very-long-string-so-very-long-string-so-very-long-strings@dontwannacry.com.exploit-0afe007b03a34169c10b8fc501510091.exploit-server.net
```

[![Inconsistent-handling-exceptional-input](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/raw/main/images/Inconsistent-handling-exceptional-input.png)](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/blob/main/images/Inconsistent-handling-exceptional-input.png)

![[Pasted image 20250220122622.png]]

[PortSwigger Lab: Inconsistent handling of exceptional input](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-inconsistent-handling-of-exceptional-input)

### Auth Token bypass Macro

> If the authentication login is protected against brute force by using random token that is used on every login POST, a Burp Macro can be used to bypass protection.

> Create Burp Macro

1. Open Proxy settings and select **sessions** under Project choices.
2. Scroll down to `Macros`, and add new macro.
3. Select **request** from the list to use for the value to be used.
4. click `Configure item` and add custom parameter location to extract.
5. Click **OK** to return to Sessions under Project choices.
6. Add a Session handling **rule**, and the editor dialogue opens.
7. In the dialogue, go to the "Scope" tab.
8. Under scope for the session handling rule editor, **check** Target, Intruder, and Repeater.
9. Still under "URL Scope", select `Include all URLs`.
10. Close Settings.

[![How To Create a Macro in Burp Suite Professional](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/raw/main/images/create-macro.png)](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/blob/main/images/create-macro.png)
[PortSwigger Lab: Infinite money logic flaw - show how to create Burp Macro](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-infinite-money)

### Current Password

> _**Identify**_ the Change password do not need the `current-password` parameter to set a new password, and the **user** whom password will be changed is based on POST parameter `username=administrator`  
> In the PortSwigger labs they provide you the credentials for `wiener:peter`, and this simulate in the exam stage 1 achieved low level user access. In exam this password reset vulnerability is example of how it is possible without **interaction** from active user to privilege escalate your access to admin.

> Intercept the `/my-account/change-password` request as the `csrf` token is single random use value, set `username=administrator`, and remove `current-password` parameter.

[![Change password without current](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/raw/main/images/change-password-without-current.png)](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/blob/main/images/change-password-without-current.png)

[PortSwigger Lab: Weak isolation on dual-use endpoint](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-weak-isolation-on-dual-use-endpoint)

### LAB: Update Email `dontwannacry` `/admin`

* Go the change email address > register email with domain `@dontwannacry.com`
	* We got it, permissions admin with account dontwannacry.
#### ¿Por qué pasó esto?

1. Definitivamente por las inconsistencias de los controles de seguridad, se relajan la mayoría de paginas cuando crean el primer control de seguridad verificando el correo para la creación de una cuenta de usuario, pero de ahi para adelante ya no se logra nada porque no siguen manteniendo los controles de seguridad tanto que no verifican la actualización de email **update email,** y en este caso eso fue lo que nos permitió actualizar al dominio `dontwannacry` y poder entrar a la sesión de Admin, que solo era posible desde una cuenta de user con el dominio de dontwannacry.
### LAB: Aislamiento débil en terminales de doble uso `/Admin`

* Este lab consiste en interceptar la peticion de `/my-account/change-password` cambiando los params body por el de `wiener->admin` y quitando el param body de `current-password` dejando solo `new-password-1 y new-password-2` de esta forma saltamos la restriccion de cambiar la pass de otro user. 

```js
//PETICION ORIGINAL - ANTES DEL ATAQUE
POST /my-account/change-password HTTP/2
content-length: 4
Cache-Control: etc...


csrf=value-CSRF&username=administrator&Current-password=trasher34&new-password-1=pass123&new-password-2=pass123

// PETICION ATAQUE EXITOSO
POST /my-account/change-password HTTP/2
content-length: 4
Cache-Control: etc...


csrf=value-CSRF&username=administrator&new-password-1=pass123&new-password-2=pass123
```


### LAB: Omisión de autenticación a través de una maquina de estado defectuosa

- Tenemos que iniciar sesión como wiener con el fin de luego en target> hace un discover content y encontrar la URL de admin/
    - En estos casos, con el fin de saber el panel de admin está, tenemos que entrar allí.
- Y bueno, lo hacemos de la forma, ingresando como wiener:peter pero en la parte de select-role que era lo que veiamos (**user, author-content**), le dabamos un DROP en intercept de burpsuite (claramente debemos tenerlo en ON) para poder tomar este salto de la interfaz, y alli:
- Veremos que ya tenemos en la pagina principal la interfaz de admin panel, para poder borrar al user carlos, allí estariamos bypasseando la autenticación de select role y llegando directamente a admin panel.

### LAB: Omisión de autenticación mediante Oracle de cifrado

```js
Oracle encryption bypass (https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-authentication-bypass-via-encryption-oracle)
-> Stay logged in encoded cookie
-> Post comment with invalid mail ('invalid') sets notification cookie that is encrypted and decrypted in the next request with oracle encryption
-> If you copy your stay-logged-in cookie into notification cookie in decrypt tab you see wiener:1711060443422, so we know the cookie is user+timestamp
-> administrator:1711060443422 has appended "Invalid email address: " so in decoder we errase 23 bytes corresponding to that
-> we get an error saying we need to have a multiple of 16, so we padd it with 9 bytes to: xxxxxxxxxadministrator:1711060443422 and delete 32 bytes in encoder
-> Once you have the notification as administrator:timestamp correctly, copy it to stay-logged-in and delete the rest, access /admin
```

![[Pasted image 20250220165340.png]]

### Lab: Bypassing access controls using email address parsing discrepancies Level:Expert `admin` By portswigger Solution

## Exploit the vulnerability using UTF-7

1. Register an account with the following UTF-7 encoded email:

    `=?utf-7?q?attacker&AEA-[YOUR-EXPLOIT-SERVER_ID]&ACA-?=@ginandjuice.shop`.

    This is the string `attacker@[YOUR-EXPLOIT-SERVER-ID] ?=@ginandjuice.shop`, with the @ symbol and space encoded in UTF-7.

2. Click **Email client**. Notice that you have been sent a registration validation email. This is because the encoded email address has passed validation due to the `@ginandjuice.shop` portion at the end, but the email server has interpreted the registration email as `attacker@[YOUR-EXPLOIT-SERVER-ID]`.
    
3. Click the confirmation link to activate the account.
## Gain admin access

1. Click **My account** and log in using the details you registered.
    
2. Click **Admin panel** to access the list of users.
    
3. Delete the `carlos` user to solve the lab.

<hr> 

eso es todo. 